<%- include('partials/header')%>

    <body id="page-top">
        <!-- Page Wrapper -->
        <div id="wrapper">
            <%- include('partials/sidebar menu')%>
                <!-- Content Wrapper -->
                <div id="content-wrapper" class="d-flex flex-column">
                    <!-- Main Content -->
                    <div id="content">
                        <%- include('partials/topbar menu')%>
                            <!-- Begin Page Content -->
                            <div class="container-fluid">
                                <!-- Page Heading -->
                                <input type="hidden" name="user" id="user" value="<%= user.name %>">
                                <h3 class="h3 mb-0 text-gray-800">Users</h3>
                                <h5 class="h5 mt-2 text-gray-600">This is data of users</h5>

                                <div class="card shadow mb-4">
                                    <div class="card-header">
                                        <button class="btn btn-primary">Add</button>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <div id="dataTable_wrapper" class="dataTables_wrapper dt-bootstrap4">
                                                <div class="row">
                                                    <div class="col-sm-12 col-md-6">
                                                        <div class="dataTables_length"><label>Show
                                                                <select name="dataTable_length" id="dataTable_length"
                                                                    aria-controls="dataTable"
                                                                    class="custom-select custom-select-sm form-control form-control-sm">
                                                                    <option value=3>3</option>
                                                                    <option value=10>10</option>
                                                                    <option value=100>100</option>
                                                                </select> entries</label></div>
                                                    </div>
                                                    <div class="col-sm-12 col-md-6">
                                                        <div id="dataTable_filter" class="dataTables_filter">
                                                            <label>Search:<input type="search"
                                                                    class="form-control form-control-sm" placeholder=""
                                                                    aria-controls="dataTable"></label>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-sm-12">
                                                        <table class="table table-bordered dataTable" id="dataTable"
                                                            width="100%" cellspacing="0" role="grid"
                                                            aria-describedby="dataTable_info" style="width: 100%;">
                                                            <thead>
                                                                <tr role="row">
                                                                    <th id="useridThead" class="sorting sorting_asc"
                                                                        tabindex="0" aria-controls="dataTable"
                                                                        rowspan="1" colspan="1"
                                                                        aria-label="User ID: activate to sort column descending"
                                                                        style="width: 162px;" aria-sort="ascending">User
                                                                        ID
                                                                    </th>
                                                                    <th id="emailThead" class="sorting" tabindex="0"
                                                                        aria-controls="dataTable" rowspan="1"
                                                                        colspan="1"
                                                                        aria-label="Email: activate to sort column ascending"
                                                                        style="width: 162px;">Email
                                                                    </th>
                                                                    <th id="nameThead" class="sorting" tabindex="0"
                                                                        aria-controls="dataTable" rowspan="1"
                                                                        colspan="1"
                                                                        aria-label="Name: activate to sort column ascending"
                                                                        style="width: 162px;">Name
                                                                    </th>
                                                                    <th id="roleThead" class="sorting" tabindex="0"
                                                                        aria-controls="dataTable" rowspan="1"
                                                                        colspan="1"
                                                                        aria-label="Role: activate to sort column ascending"
                                                                        style="width: 162px;">Role
                                                                    </th>
                                                                    <th style="width: 162px;">
                                                                        Action
                                                                    </th>
                                                                </tr>
                                                            </thead>
                                                            <tfoot>
                                                                <tr>
                                                                    <th rowspan="1" colspan="1">User ID</th>
                                                                    <th rowspan="1" colspan="1">Email</th>
                                                                    <th rowspan="1" colspan="1">Name</th>
                                                                    <th rowspan="1" colspan="1">Role</th>
                                                                    <th rowspan="1" colspan="1">Action</th>
                                                                </tr>
                                                            </tfoot>
                                                            <tbody>

                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-sm-12 col-md-5">
                                                        <div class="dataTables_info" id="dataTable_info" role="status"
                                                            aria-live="polite">Showing 1 to 10 of 57 entries</div>
                                                    </div>
                                                    <div class="col-sm-12 col-md-7">
                                                        <div class="dataTables_paginate paging_simple_numbers"
                                                            id="dataTable_paginate">
                                                            <ul class="pagination">
                                                                <li class="paginate_button page-item previous disabled"
                                                                    id="dataTable_previous"><a href="#"
                                                                        aria-controls="dataTable" data-dt-idx="0"
                                                                        tabindex="0" class="page-link">Previous</a></li>
                                                                <li class="paginate_button page-item active"><a href="#"
                                                                        aria-controls="dataTable" data-dt-idx="1"
                                                                        tabindex="0" class="page-link">1</a></li>
                                                                <li class="paginate_button page-item "><a href="#"
                                                                        aria-controls="dataTable" data-dt-idx="2"
                                                                        tabindex="0" class="page-link">2</a></li>
                                                                <li class="paginate_button page-item "><a href="#"
                                                                        aria-controls="dataTable" data-dt-idx="3"
                                                                        tabindex="0" class="page-link">3</a></li>
                                                                <li class="paginate_button page-item "><a href="#"
                                                                        aria-controls="dataTable" data-dt-idx="4"
                                                                        tabindex="0" class="page-link">4</a></li>
                                                                <li class="paginate_button page-item "><a href="#"
                                                                        aria-controls="dataTable" data-dt-idx="5"
                                                                        tabindex="0" class="page-link">5</a></li>
                                                                <li class="paginate_button page-item "><a href="#"
                                                                        aria-controls="dataTable" data-dt-idx="6"
                                                                        tabindex="0" class="page-link">6</a></li>
                                                                <li class="paginate_button page-item next"
                                                                    id="dataTable_next"><a href="#"
                                                                        aria-controls="dataTable" data-dt-idx="7"
                                                                        tabindex="0" class="page-link">Next</a></li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-footer">
                                        <ul class="pagination mt-3">

                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <p></p>

                    </div>
                    <%- include('partials/footer')%>

                </div>
        </div>

        <script>
            var readParams = {
                page: 1,
                totalPages: 1,
                limit: 3,
                sortBy: "userid",
                order: "asc"
            }

            const readData = (params) => {
                fetch(`http://localhost:3000/data/users?${new URLSearchParams(params).toString()}`).then((response) => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                    .then((response) => {
                        newParams = { ...params };


                        let useridThead = document.getElementById('useridThead')
                        let emailThead = document.getElementById('emailThead')
                        let nameThead = document.getElementById('nameThead')
                        let roleThead = document.getElementById('roleThead')


                        if (params.sortBy == "userid" && params.order == "asc") {
                            useridThead.className = 'sorting sorting_asc'
                        } else if (params.sortBy == "userid" && params.order == "desc") {
                            useridThead.className = 'sorting sorting_desc'
                        } else {
                            useridThead.className = 'sorting'
                        }

                        if (params.sortBy == "email" && params.order == "asc") {
                            emailThead.className = 'sorting sorting_asc'
                        } else if (params.sortBy == "email" && params.order == "desc") {
                            emailThead.className = 'sorting sorting_desc'
                        } else {
                            emailThead.className = 'sorting'
                        }

                        if (params.sortBy == "name" && params.order == "asc") {
                            nameThead.className = 'sorting sorting_asc'
                        } else if (params.sortBy == "name" && params.order == "desc") {
                            nameThead.className = 'sorting sorting_desc'
                        } else {
                            nameThead.className = 'sorting'
                        }

                        if (params.sortBy == "role" && params.order == "asc") {
                            roleThead.className = 'sorting sorting_asc'
                        } else if (params.sortBy == "role" && params.order == "desc") {
                            roleThead.className = 'sorting sorting_desc'
                        } else {
                            roleThead.className = 'sorting'
                        }

                        let htmlTbody = '';
                        response.data.forEach((item, index) => {
                            if (document.getElementById('user').value == item.name) {
                                htmlTbody += `
                            <tr>
                                <td>${item.userid}</td>
                                <td>${item.email}</td>
                                <td>${item.name}</td>
                                <td>${item.role}</td>
                                <td></td>
                            </tr>
                            `
                            } else {
                                htmlTbody += `
                            <tr>
                                <td>${item.userid}</td>
                                <td>${item.email}</td>
                                <td>${item.name}</td>
                                <td>${item.role}</td>
                                <td><button type="button" class="btn btn-danger" onClick="deleteData('${item.email}')"><i class="fa-solid fa-trash-can"></i></button></td>
                            </tr>
                            `
                            }
                        })
                        document.querySelector('table tbody').innerHTML = htmlTbody

                        let startingIndex = (response.page - 1) * response.limit

                        let showEntryText = ''
                        if (response.totalData == 0) {
                            showEntryText += `Showing 0 to 0 of 0 entries`
                        } else if (response.page * response.limit > response.totalData || response.limit == 0) {
                            showEntryText += `Showing ${startingIndex + 1} to ${response.totalData} of ${response.totalData}`
                        } else {
                            showEntryText += `Showing ${startingIndex + 1} to ${response.page * response.limit} of ${response.totalData}`
                        }
                        document.getElementById('dataTable_info').innerText = showEntryText


                        let paging = '';
                        params.page = 1;
                        paging += `<button type="button" class="page-link" onClick='readData(${JSON.stringify(params)})'><span aria-hidden="true">&laquo;</span></button>`
                        for (let i = 1; i <= response.totalPages; i++) {
                            if (response.page == i) {
                                params.page = i;
                                paging += `<li class="page-item active"><button type="button" class="page-link" onClick='readData(${JSON.stringify(params)})'>${i}</button></li>`
                            }
                            else {
                                params.page = i;
                                paging += `<li class="page-item"><button type="button" class="page-link" onClick='readData(${JSON.stringify(params)})'>${i}</button></li>`
                            }
                        }
                        params.page = response.totalPages;
                        paging += `<button type="button" class="page-link" onClick='readData(${JSON.stringify(params)})'><span aria-hidden="true">&raquo;</span></button>`
                        document.querySelector('.pagination').innerHTML = paging
                    })
                    .catch((err) => {
                        console.error(err);
                    });
            }

            readData(readParams)

            const resetForm = () => {
                // document.getElementById('idObj').value = ''
                // document.getElementById("form-search").reset();
            }

            const deleteData = (email) => {
                fetch(`http://localhost:3000/data/users/delete/`, {
                    method: 'PUT',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email })
                }).then((response) => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                }).then((response) => {
                    readData({ sortBy: "userid", order: "asc" })
                });
            }

            
            document.getElementById('dataTable_length').addEventListener('change', function () {
                const selectElement = document.getElementById('dataTable_length');
                readParams.limit = selectElement.value
                readData(readParams)
            });

            const useridThead = document.getElementById("useridThead")
            const emailThead = document.getElementById("emailThead")
            const nameThead = document.getElementById("nameThead")
            const roleThead = document.getElementById("roleThead")

            useridThead.onclick = function () {
                if (readParams.sortBy != 'userid') {
                    readParams.sortBy = 'userid'
                    readParams.order = 'asc'
                } else if (readParams.order == 'asc') {
                    readParams.order = 'desc'
                } else {
                    readParams.order = 'asc'
                }
                readData(readParams)
            }

            emailThead.onclick = function () {
                if (readParams.sortBy != 'email') {
                    readParams.sortBy = 'email'
                    readParams.order = 'asc'
                } else if (readParams.order == 'asc') {
                    readParams.order = 'desc'
                } else {
                    readParams.order = 'asc'
                }
                readData(readParams)
            }
            nameThead.onclick = function () {
                if (readParams.sortBy != 'name') {
                    readParams.sortBy = 'name'
                    readParams.order = 'asc'
                } else if (readParams.order == 'asc') {
                    readParams.order = 'desc'
                } else {
                    readParams.order = 'asc'
                }
                readData(readParams)
            }
            roleThead.onclick = function () {
                if (readParams.sortBy != 'role') {
                    readParams.sortBy = 'role'
                    readParams.order = 'asc'
                } else if (readParams.order == 'asc') {
                    readParams.order = 'desc'
                } else {
                    readParams.order = 'asc'
                }
                readData(readParams)
            }

        </script>

    </body>

    </html>